---
title: Vulnerability Data Cleaning Tutorial
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 12pt
output:
  word_document:
    reference_docx: ../../../templates/template.docx
  pdf_document: 
    keep_tex: true
    highlight: pygments
    includes:
      in_header: "latex-header.tex"
bibliography: packages.bib
nocite: '@*'
csl: ../../../bibliography/chicago-fullnote-bibliography-with-ibid.csl
compact-title: false
---

In this exercise, we will explore SDG's 13.1.1 indicator, associated with Target 13.1. The indicator's associated data is from the Emergency Events Database (EM-DAT), managed by the Centre for Research on the Epidemiology of Disasters (CRED) [-@CRED2021].

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      purl = TRUE,
                      out.extra = '',
                      knitr.duplicate.label = "allow",
                      tidy.opts = list(width.cutoff = 40), 
                      tidy = TRUE,
                      strip.white = FALSE)

```


## Load libraries

First, we need to load the following libraries:

```{r libraries, message=FALSE, warning=FALSE}
library(here)
#library(tidyverse)
library(dplyr)
library(stringr)
library(janitor)
library(scales)
library(kableExtra)
library(ggrepel)
library(ggforce)
library(treemapify)
library(extrafont)
loadfonts(device = "win")
```


## Import UNFCCC emissions data

```{r import clean dataset, warning=FALSE, message=FALSE}
unfccc_emissions <- utils::read.csv(here::here("scripts/cleaning/unfccc-emissions", "unfccc-emissions-clean.csv"), stringsAsFactors = TRUE)
```

## Merge with EM-DAT

```{r sum totals, warning=FALSE, message=FALSE}
em_dat <- utils::read.csv(here::here("scripts/cleaning/em-dat", "em-dat-clean.csv"), stringsAsFactors = TRUE)

totals <- em_dat %>% 
  dplyr::ungroup() %>% 
  dplyr::select(!c(disaster_type, no_injured, no_affected, no_homeless)) %>%
  dplyr::group_by(iso, country, year) %>%
  dplyr::summarise_all(funs(sum), na.rm = TRUE) %>%
  dplyr::na_if(., 0)
```

We need to ungroup data before we remove any variables, otherwise it wouldn't work. Here we are summing over all types of disasters by countries and year so we can compare them by emissions.

```{r merge two datasets, warning=FALSE, message=TRUE}
vulnerability <- unfccc_emissions %>% 
  dplyr::filter(year != "base_year", type != "Total GHG emissions with LULUCF", !(country %in% c("European Union (Convention)", "European Union (KP)"))) %>%
  fuzzyjoin::regex_left_join(totals, by = c("year" = "year", "iso" = "iso")) %>%
  dplyr::select(-year.y, -iso.y, -country.y, -type) %>%
  dplyr::rename("year" = "year.x", "iso" = "iso.x", "country" = "country.x", "co2_unfccc" = "co2")

rm(totals, em_dat, unfccc_emissions)
```

Now we have a dataset that includes UNFCCC GHG emissions without Land Use, Land-Use Chang and Forestry (LULUCF) and people affected as a result of climate-related disasters. We chose to exclude LULUCF from the analysis because we wanted to measure gross emissions instead of net emissions, which can be misleading especially for well-endowed carbon sinks nations.


We know our UNFCCC emissions data analysis that many Non-Annex I party submit their GHG inventories the least which makes it difficult to aggregate their cumulative emissions, with the highest levels of missing values located in Africa and Oceania. We will use data from the Global Carbon Project [-@Friedlingstein2020] to calculate cumulative CO~2~ based on their estimates.

First, let's calculate the cumulative, average, and capita emissions and vulnerabilities for each country based on the UNFCCC and EM-DAT data:

```{r unfccc cumulative and mean co2, warning=FALSE, message=FALSE}
vulnerability_cumulative <- vulnerability %>%
  dplyr::ungroup() %>%
  dplyr::select(-ghg, -year) %>%
  dplyr::group_by(iso, country, region, group) %>%
  dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_cumulative")}, where(is.numeric))

vulnerability_mean <- vulnerability %>%
  dplyr::ungroup() %>%
  dplyr::select(-ghg, -year) %>%
  dplyr::group_by(iso, country, region, group) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_average")}, where(is.numeric))
```

This will add up and average all the deaths, injuries, affected, and damages for each country from 1990 to 2021, and all the CO~2~ emissions from 1990-2018.

To add a population capita value to emissions and vulnerabilities, we first need to import population data and merge it with our `vulnerability` dataset. We will use the [population dataset](https://datahub.io/core/population) that's been sourced from several sources. This dataset is in long format, and the population is measured in raw count, which is total people. After weighting the emissions and climate vulnerabilities, we again calculate the cumulative and the average for each variable separately

```{r population capita co2, warning=FALSE, message=FALSE}
download.file("https://datahub.io/core/population/r/population.csv", "population.csv")

pop <- utils::read.csv("population.csv", stringsAsFactors = TRUE) %>% 
  janitor::clean_names() %>%
  filter(year >= 1990) %>%
  mutate(year = as.factor(year)) %>%
  dplyr::rename("population" = "value") 

vulnerability_capita <- vulnerability %>%
  dplyr::ungroup() %>%
  dplyr::select(-ghg) %>%
  dplyr::left_join(pop, by = c("year" = "year", "iso" = "country_code")) %>%
  dplyr::select(-country_name) %>%
  dplyr::mutate_if(is.numeric, funs(. / population)) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_capita")}, where(is.numeric))
```

Next, we will calculate both the capita cumulative and capita average to see any difference.

```{r unfccc capita cumulative and mean co2, warning=FALSE, message=FALSE}
vulnerability_cumulative_capita <- vulnerability_capita %>%
  dplyr::ungroup() %>%
  select(-population_capita) %>%
  dplyr::group_by(iso, country, region, group) %>%
  dplyr::select_if(is.numeric) %>%
  dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_cumulative")}, where(is.numeric))

vulnerability_mean_capita <- vulnerability_capita %>%
  dplyr::ungroup() %>%
  select(-population_capita) %>%
  dplyr::group_by(iso, country, region, group) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_average")}, where(is.numeric))
```

```{r merge all, warning=FALSE, message=TRUE}
vulnerability_all <- vulnerability_cumulative %>%
  dplyr::left_join(vulnerability_mean, by = c("iso" = "iso", "country" = "country", "region" = "region", "group" = "group")) %>%
  dplyr::left_join(vulnerability_cumulative_capita, by = c("iso" = "iso", "country" = "country", "region" = "region", "group" = "group")) %>%
  dplyr::left_join(vulnerability_mean_capita, by = c("iso" = "iso", "country" = "country", "region" = "region", "group" = "group"))

rm(vulnerability_cumulative, vulnerability_cumulative_capita, vulnerability_mean, vulnerability_mean_capita, vulnerability_capita)
```

