---
title: Vulnerability Data Analysis Tutorial
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 12pt
output:
  word_document:
    reference_docx: ../../../templates/template.docx
  pdf_document: 
    keep_tex: true
    highlight: pygments
    includes:
      in_header: "latex-header.tex"
bibliography: packages.bib
nocite: '@*'
csl: ../../../bibliography/chicago-fullnote-bibliography-with-ibid.csl
compact-title: false
---

In this exercise, we will explore SDG's 13.1.1 indicator, associated with Target 13.1. The indicator's associated data is from the Emergency Events Database (EM-DAT), managed by the Centre for Research on the Epidemiology of Disasters (CRED) [-@CRED2021].

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      purl = TRUE,
                      out.extra = '',
                      knitr.duplicate.label = "allow",
                      tidy.opts = list(width.cutoff = 40), 
                      tidy = TRUE,
                      strip.white = FALSE)

```

## Load libraries

First, we need to load the following libraries:

```{r libraries, message=FALSE, warning=FALSE}
library(here)
#library(tidyverse)
library(dplyr)
library(stringr)
library(janitor)
library(scales)
library(kableExtra)
library(ggrepel)
library(ggforce)
library(treemapify)
library(extrafont)
loadfonts(device = "win")
```


## Data Analysis

In this section we will explore how different data transformations can produce different conclusions. We will look at three different transformations: cumulative, average, and capita measures. Cumulative transformations add up all the values based on a category. For this exercise we will calculate the cumulative emissions and vulnerabilities over *time*, i.e. from 1990 to 2018. 

Average estimates is just that: the average emissions for a given period. The one most of us know about is the arithmetic average, which adds up all the values and divides them by the count of values, so in this instance we will add up the number of emissions and vulnerabilities over time and divide them by the number of years in the dataset which is 29 years. This type of average is not recommended for time-related data because it gives equal capita for all years and does not capture changes over time. There are methods that deal with this issue but it is beyond the scope of this textbook.

Finally, we can use weighting methods to add more perspective to our data and makes our data a little more standardized. For example, we can use population data to normalize emissions and vulnerabilities, meaning we can measure emissions and vulnerabilities per 100,000 people (which demographers call it rate) that way it makes it easier to compare countries with large populations to smaller ones.

In this part of the module, we will explore the three different measures, and disaggregate them by country and region.

### UNFCCC data




### Global Carbon Project data

We will first import the Global Carbon Project dataset, then convert into the long format.

```{r import dataset, warning=FALSE, message=FALSE}
gcp <- readxl::read_excel(here::here("data/global-carbon-project", "National-Carbon-Emissions-2020-v1.0-raw.xlsx"), 
                          sheet = 2, 
                          skip = 11, 
                          na = "NaN") %>%
  dplyr::rename(year = `...1`)
```

GCP publishes its data in million tonnes of fossil carbon. To convert it to kt of CO~2~ we need to multiply it by 3664 [@Friedlingstein2020].

```{r reshape dataset, warning=FALSE, message=FALSE}
gcp_long <- gcp %>%
  dplyr::filter(year >= 1990) %>%
  tidyr::gather(country, co2_gcp, Afghanistan:World) %>%
  dplyr::mutate(co2_gcp = 3664 * co2_gcp, year = as.factor(year))

region <- countrycode::codelist %>% 
  dplyr::select(country.name.en, region, iso3c) %>% 
  dplyr::mutate(country.name.en = stringr::str_replace_all(country.name.en, 
                                                      c("Antigua & Barbuda" = "Antigua and Barbuda", 
                                                        "Bosnia & Herzegovina" = "Bosnia and Herzegovina",
                                                        "Congo - Kinshasa" = "Congo", 
                                                        "Côte d’Ivoire" = "Côte d'Ivoire", 
                                                        "Congo - Brazzaville" = "Democratic Republic of Congo",
                                                        "Czechia" = "Czech Republic",
                                                        "Faroe Islands" = "Faeroe Islands",
                                                        "Hong Kong SAR China" = "Hong Kong",
                                                        "Macao SAR China" = "Macao",
                                                        "Micronesia \\(Federated States of\\)" = "Micronesia",
                                                        "Myanmar \\(Burma\\)" = "Myanmar",
                                                        "St. Lucia" = "Saint Lucia",
                                                        "St. Vincent & Grenadines" = "Saint Vincent and the Grenadines",
                                                        "São Tomé & Príncipe" = "Sao Tome and Principe",
                                                        "Palestinian Territories" = "Occupied Palestinian Territory",
                                                        "Trinidad & Tobago" = "Trinidad and Tobago",
                                                        "Eswatini" = "Swaziland",
                                                        "Turks & Caicos Islands" = "Turks and Caicos Islands",
                                                        "United States" = "USA",
                                                        "Wallis & Futuna" = "Wallis and Futuna Islands",
                                                        "St. Kitts & Nevis" = "Saint Kitts and Nevis",
                                                        "St. Helena" = "Saint Helena",
                                                        "St. Pierre & Miquelon" = "Saint Pierre and Miquelon",
                                                        "Vietnam" = "Viet Nam")))

region$region[region$country.name.en == "Taiwan"] <- "East Asia & Pacific"

gcp_long <- gcp_long %>% 
  fuzzyjoin::regex_left_join(region, by = c(country = "country.name.en")) %>%
  dplyr::rename(iso = iso3c) %>%  
  dplyr::filter(!(country == "United Kingdom of Great Britain and Northern Ireland" & iso == "IRL"),
                !(country == "Guinea-Bissau" & iso == "GIN"),
                !(country == "Papua New Guinea" & iso == "GIN"),
                !(country == "Equatorial Guinea" & iso == "GIN"),
                !(country == "Democratic People's Republic of Korea" & iso == "KOR"),
                !(country == "Dominican Republic" & iso == "DMA"),
                !(country == "Nigeria" & iso == "NER"),
                !(country == "South Sudan" & iso == "SDN")) %>%
  filter(!is.na(region)) %>%
  select(-country.name.en) %>%
  relocate(iso, .before = country) %>%
  relocate(region, .after = country) %>%
  relocate(year, .after = region)

gcp_long$iso[gcp_long$country == "Democratic Republic of the Congo"] <- "COG"

utils::write.csv(gcp_long, here("scripts/cleaning/global-carbon-project", "gcp-long-clean.csv"), row.names = FALSE)

rm(region)
```

Here we will calculate the cumulative, average and population-capita estimates.

```{r aggregate dataset, warning=FALSE, message=FALSE}
gcp_cumulative <- gcp_long %>%
  dplyr::ungroup() %>%
  dplyr::filter(!str_detect('KP Annex B | Non KP Annex B | OECD | Non-OECD | EU27 | Africa | Asia | Central America | Europe | Middle East | North America | Oceania | South America | Bunkers | World | Statistical Difference', country)) %>%
  dplyr::group_by(iso, country, region) %>%
  dplyr::summarize(co2_gcp = sum(co2_gcp, na.rm = TRUE)) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_cumulative")}, where(is.numeric))

gcp_mean <- gcp_long %>%
  dplyr::ungroup() %>%
  dplyr::filter(!str_detect('KP Annex B | Non KP Annex B | OECD | Non-OECD | EU27 | Africa | Asia | Central America | Europe | Middle East | North America | Oceania | South America | Bunkers | World | Statistical Difference', country)) %>%
  dplyr::group_by(iso, country, region) %>%
  dplyr::summarize(co2_gcp = mean(co2_gcp, na.rm = TRUE)) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_average")}, where(is.numeric))

gcp_capita <- gcp_long %>%
  dplyr::ungroup() %>%
  dplyr::filter(!str_detect('KP Annex B | Non KP Annex B | OECD | Non-OECD | EU27 | Africa | Asia | Central America | Europe | Middle East | North America | Oceania | South America | Bunkers | World | Statistical Difference', country)) %>%
  dplyr::left_join(pop, by = c("year" = "year", "iso" = "country_code")) %>%
  select(-country_name) %>%
  dplyr::mutate(co2_gcp =  co2_gcp / population) %>%
  relocate(iso, .before = country) %>%
  relocate(year, .after = region) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_capita")}, where(is.numeric))

gcp_cumulative_capita <- gcp_capita %>%
  dplyr::ungroup() %>%
  select(-population_capita) %>%
  dplyr::group_by(iso, country, region) %>%
  dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_cumulative")}, where(is.numeric))

gcp_mean_capita <- gcp_capita %>%
  dplyr::ungroup() %>%
  select(-population_capita) %>%
  dplyr::group_by(iso, country, region) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_average")}, where(is.numeric))

gcp_all <- gcp_cumulative %>%
  dplyr::left_join(gcp_mean, by = c("iso" = "iso", "country" = "country", "region" = "region")) %>%
  dplyr::left_join(gcp_cumulative_capita, by = c("iso" = "iso", "country" = "country", "region" = "region")) %>%
  dplyr::left_join(gcp_mean_capita, by = c("iso" = "iso", "country" = "country", "region" = "region"))
  
rm(gcp_cumulative, gcp_mean, gcp_cumulative_capita, gcp_mean_capita, gcp_capita, pop)
```


```{r merge gcp cumulative with vulnerability cumulative, warning = FALSE, message=FALSE}
vulnerability_all <- vulnerability_all %>%
  dplyr::left_join(gcp_all, by = c("iso" = "iso", "region" = "region")) %>%
  na_if(., 0) %>% 
  na_if(., "NaN") %>%
  ungroup() %>%
  mutate(status_cumulative = case_when(co2_gcp_cumulative >= quantile(co2_gcp_cumulative, 0.9, na.rm = TRUE) ~ '90th percentile emitter', total_affected_cumulative >= quantile(total_affected_cumulative, 0.9, na.rm = TRUE) ~ '90th percentile affected'), status_average = case_when(co2_gcp_average >= quantile(co2_gcp_average, 0.9, na.rm = TRUE) ~ '90th percentile emitter', total_affected_average >= quantile(total_affected_average, 0.9, na.rm = TRUE) ~ '90th percentile affected'), status_capita_cumulative = case_when(co2_gcp_capita_cumulative >= quantile(co2_gcp_capita_cumulative, 0.9, na.rm = TRUE) ~ '90th percentile emitter', total_affected_capita_cumulative >= quantile(total_affected_capita_cumulative, 0.9, na.rm = TRUE) ~ '90th percentile affected'), status_capita_average = case_when(co2_gcp_capita_average >= quantile(co2_gcp_capita_average, 0.9, na.rm = TRUE) ~ '90th percentile emitter', total_affected_capita_average >= quantile(total_affected_capita_average, 0.9, na.rm = TRUE) ~ '90th percentile affected')) %>%
  dplyr::filter(!(country.x == "Congo" & country.y == "Democratic Republic of the Congo"),
                !(country.x == "Democratic Republic of the Congo" & country.y == "Congo"),
                !(country.x == "Guinea" & country.y == "Equatorial Guinea")) %>%
  select(-country.y) %>%
  rename("country" = "country.x")

utils::write.csv(vulnerability_all, here("scripts/cleaning/vulnerability", "emissions-vulnerability-cumulative-clean.csv"), row.names = FALSE)
```


```{r plot vulnerability versus emissions (cumulative with outliers), warning=FALSE, message=FALSE, caption = "Cumulative emissions and climate-related vulnerabilites (1990-2018)"}
vulnerability_all %>%
  drop_na(total_affected_cumulative) %>%
  ggplot2::ggplot(aes(x = co2_gcp_cumulative, y = total_affected_cumulative, color = str_wrap(region, 15))) +
  ggplot2::geom_point(size = 3, alpha = 0.75) + 
  theme_minimal() +
  ggplot2::scale_y_continuous(labels = unit_format(unit = "B", scale = 1e-9, accuracy = 0.01)) + 
  ggplot2::scale_x_continuous(labels = unit_format(unit = "", scale = 1e-6)) +
  geom_text_repel(aes(label=ifelse(co2_gcp_cumulative >= quantile(co2_gcp_cumulative, 0.9, na.rm = TRUE), as.character(iso),'')), show.legend = FALSE, color = "black", size = 3) +
  facet_zoom(xlim = c(150,1.640593e+07), ylim = c(99, 69000000), horizontal = FALSE) +
  xlab(expression(CO[2]~(Gt))) +
  ylab("Total affected people") +
  ggplot2::scale_color_brewer(palette = "Paired", name = "Regions") +
  ggplot2::theme(text=element_text(family = "Arial", size = 11), 
                 axis.title.x = element_text(family = "Arial", size = 12), 
                 axis.title.y = element_text(family = "Arial", size = 12, margin = margin(t = 0, r = 20, b = 0, l = 0)), 
                 legend.text=element_text(family = "Arial", size=10))
```

```{r plot vulnerability versus emissions (cumulative without outliers), warning=FALSE, message=FALSE, caption = "Cumulative emissions and climate-related vulnerabilites (1990-2018)"}
vulnerability_all %>%
  drop_na(total_affected_cumulative) %>%
  filter(!str_detect('China | United States of America | India | Russian Federation', as.character(country))) %>%
  ggplot2::ggplot(aes(x = co2_gcp_cumulative, y = total_affected_cumulative, color = region)) +
  ggplot2::geom_point(size = 3, alpha = 0.75) + 
  theme_minimal() +
  ggplot2::scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6)) + 
  ggplot2::scale_x_continuous(labels = unit_format(unit = "", scale = 1e-6)) +
  geom_text_repel(aes(label=ifelse(co2_gcp_cumulative >= quantile(co2_gcp_cumulative, 0.9, na.rm = TRUE), as.character(iso),'')), show.legend = FALSE, color = "black", size = 3.5) +
  geom_text_repel(aes(label=ifelse(total_affected_cumulative >= quantile(total_affected_cumulative, 0.9, na.rm = TRUE), as.character(iso),'')), show.legend = FALSE, color = "black", size = 3.5) +
  xlab(expression(CO[2]~(Gt))) +
  ylab("Total affected people") +
  ggplot2::scale_color_brewer(palette = "Paired", name = "Regions") +
  ggplot2::theme(text=element_text(family = "Arial", size = 11), 
                 axis.title.x = element_text(family = "Arial", size = 12), 
                 axis.title.y = element_text(family = "Arial", size = 12), 
                 legend.text=element_text(family = "Arial", size=11))
```

```{r plot vulnerability versus emissions (average with outliers), warning=FALSE, message=FALSE, caption = "Mean emissions and climate-related vulnerabilites (1990-2018)"}
vulnerability_all %>%
  drop_na(total_affected_average) %>%
  ggplot2::ggplot(aes(x = co2_gcp_average, y = total_affected_average, color = region)) +
  ggplot2::geom_point(size = 3, alpha = 0.75) + 
  theme_minimal() +
  ggplot2::scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6)) + 
  ggplot2::scale_x_continuous(labels = unit_format(unit = "", scale = 1e-6)) +
  geom_text_repel(aes(label=ifelse(co2_gcp_average >= quantile(co2_gcp_average, 0.9, na.rm = TRUE),as.character(iso),'')), show.legend = FALSE, color = "black", size = 3.5) +
  xlab(expression(CO[2]~(Gt))) +
  ylab("Total affected people") +
  ggplot2::scale_color_brewer(palette = "Paired", name = "Regions") +
  ggplot2::theme(text=element_text(family = "Arial", size = 11), 
                 axis.title.x = element_text(family = "Arial", size = 12), 
                 axis.title.y = element_text(family = "Arial", size = 12), 
                 legend.text=element_text(family = "Arial", size=11))
```

```{r plot vulnerability versus emissions (capita cumulative), warning=FALSE, message=FALSE, caption = "Cumulative emissions and average climate-related vulnerabilites capita by population (1990-2018)"}
vulnerability_all %>%
  drop_na(total_affected_capita_average) %>%
  ggplot2::ggplot(aes(x = co2_gcp_capita_cumulative, y = total_affected_capita_cumulative, color = region)) +
  ggplot2::geom_point(size = 3, alpha = 0.75) + 
  theme_minimal() +
#  ggplot2::scale_y_continuous(labels = unit_format(unit = "", scale = 1e-3)) + 
#  ggplot2::scale_x_continuous(labels = unit_format(unit = "", scale = 1e-3)) +
  geom_text_repel(aes(label=ifelse(co2_gcp_capita_cumulative >= quantile(co2_gcp_capita_cumulative, 0.9, na.rm = TRUE), as.character(country),'')), show.legend = FALSE, color = "black", size = 3) +
  geom_text_repel(aes(label=ifelse(total_affected_capita_average >= quantile(total_affected_capita_average, 0.9, na.rm = TRUE), as.character(country),'')), show.legend = FALSE, color = "black", size = 3) +
  xlab(expression(CO[2]~(kt))) +
  ylab("Total affected people") +
  ggplot2::scale_color_brewer(palette = "Paired", name = "Regions") +
  ggplot2::theme(text=element_text(family = "Arial", size = 11), 
                 axis.title.x = element_text(family = "Arial", size = 12), 
                 axis.title.y = element_text(family = "Arial", size = 12), 
                 legend.text=element_text(family = "Arial", size=11))
```

```{r plot vulnerability versus emissions (capita average), warning=FALSE, message=FALSE, caption = "Cumulative emissions and climate-related vulnerabilites capita by population (1990-2018)"}
vulnerability_all %>%
  drop_na(total_affected_capita_average) %>%
  ggplot2::ggplot(aes(x = co2_gcp_capita_average, y = total_affected_capita_average, color = region)) +
  ggplot2::geom_point(size = 3, alpha = 0.75) + 
  theme_minimal() +
#  ggplot2::scale_y_continuous(labels = unit_format(unit = "", scale = 1e-3)) + 
#  ggplot2::scale_x_continuous(labels = unit_format(unit = "", scale = 1e-3)) +
  geom_text_repel(aes(label=ifelse(co2_gcp_capita_cumulative >= quantile(co2_gcp_capita_cumulative, 0.9, na.rm = TRUE), as.character(iso),'')), show.legend = FALSE, color = "black", size = 3.5) +
  geom_text_repel(aes(label=ifelse(total_affected_capita_cumulative >= quantile(total_affected_capita_cumulative, 0.9, na.rm = TRUE), as.character(iso),'')), show.legend = FALSE, color = "black", size = 3.5) +
  xlab(expression(CO[2]~(kt))) +
  ylab("Total affected people (000s)") +
  ggplot2::scale_color_brewer(palette = "Paired", name = "Regions") +
  ggplot2::theme(text=element_text(family = "Arial", size = 11), 
                 axis.title.x = element_text(family = "Arial", size = 12), 
                 axis.title.y = element_text(family = "Arial", size = 12), 
                 legend.text=element_text(family = "Arial", size=11))
```

```{r top emitters and top affected minus outliers, message=FALSE, warning=FALSE, eval = FALSE}
top_emitters <- vulnerability_all %>%
  filter(!str_detect('China | USA | India | Russian Federation', country) & co2_gcp >= quantile(co2_gcp, 0.9, na.rm = TRUE)) %>%
  arrange(desc(co2_gcp)) %>%
  filter(!str_detect('Thailand', country))

top_affected <- vulnerability_all %>%
  filter(!str_detect('China | USA | India | Russian Federation', country) & total_affected >= quantile(total_affected, 0.9, na.rm = TRUE)) %>%
  arrange(desc(total_affected))
```


```{r top co2 emitters, warning=FALSE, message=FALSE}
vulnerability_all %>% 
  select(country, region, co2_gcp_cumulative, total_affected_cumulative) %>% 
  arrange(desc(co2_gcp_cumulative)) %>%
  top_frac(0.1, co2_gcp_cumulative) %>%
  mutate_each(funs(prettyNum(., big.mark=","))) %>%
  kbl(col.names = c("Country", "Region", "CO~2~", "Affected People")) %>% 
  kableExtra::kable_classic(full_width = FALSE)

vulnerability_all %>% 
  select(country, region, co2_gcp_cumulative, total_affected_cumulative) %>% 
  arrange(desc(total_affected_cumulative)) %>%
  top_frac(0.1, total_affected_cumulative) %>%
  mutate_each(funs(prettyNum(., big.mark=","))) %>%
  kbl(col.names = c("Country", "Region", "CO~2~", "Affected People")) %>% 
  kableExtra::kable_classic(full_width = FALSE)

vulnerability_all %>% 
  select(country, region, co2_gcp_capita_average, total_affected_capita_average) %>% 
  arrange(desc(co2_gcp_capita_average)) %>%
  top_frac(0.1, co2_gcp_capita_average) %>%
  mutate_each(funs(prettyNum(., big.mark=","))) %>%
  kbl(col.names = c("Country", "Region", "CO~2~", "Affected People")) %>% 
  kableExtra::kable_classic(full_width = FALSE)

vulnerability_all %>% 
  select(country, region, co2_gcp_capita_average, total_affected_capita_average) %>% 
  arrange(desc(total_affected_capita_average)) %>%
  top_frac(0.1, total_affected_capita_average) %>%
  mutate_each(funs(prettyNum(., big.mark=","))) %>%
  kbl(col.names = c("Country", "Region", "CO~2~", "Affected People")) %>% 
  kableExtra::kable_classic(full_width = FALSE)
```



## Visualizations


Here we will create two treemaps: one for cumulative emissions and another for cumulative affected people by climate-related disasters.

```{r treemaps emissions, warning=FALSE, message=FALSE}
vulnerability_all %>%
  ggplot(aes(area = co2_gcp_cumulative, fill = region, subgroup = region)) +
  geom_treemap() +
  geom_treemap_subgroup_border(size = 1) +
  scale_fill_brewer(palette = "Greens") +
#  scale_fill_hue(l=40, c=35) +
#  geom_treemap_subgroup_text(grow = FALSE, place = "centre", size = 12, color = "black", reflow = TRUE) +
  theme_void() + 
  theme(legend.position = "none") +
  annotate("text", x = 0.17, y = 0.26, label = "East Asia & Pacific", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.17, y = 0.22, label = paste0("275.8~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey46", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.17, y = 0.81, label = "Europe & Central Asia", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.17, y = 0.77, label = paste0("209.9~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey46", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.74, y = 0.26, label = "North America", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.74, y = 0.22, label = paste0("184.9~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey36", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.60, y = 0.68, label = "Middle East & North\nAfrica", size = 4.5, family = "Arial", color = "grey20", lineheight = .75, hjust = 0) +
  annotate("text", x = 0.60, y = 0.625, label = paste0("53.4~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey36", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.88, y = 0.69, label = "South Asia", size = 4.5, family = "Arial", color = "grey20", hjust = 0) +
  annotate("text", x = 0.88, y = 0.65, label = paste0("47.5~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey30", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.60, y = 0.95, label = "Latin America &\nCaribbean", size = 4.5, family = "Arial", color = "grey20", hjust = 0, lineheight = .75) +
  annotate("text", x = 0.60, y = 0.89, label = paste0("43.6~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey36", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.915, y = 0.925, label = "Sub-\nSaharan\nAfrica", size = 4, family = "Arial", color = "grey77", lineheight = .75, hjust = 0) +
  annotate("text", x = 1, y = 0.99, label = paste0("19.3~Gt"), size = 3.1, family = "Arial", color = "grey76", hjust = 1.4, vjust = 1.45, parse = TRUE, angle = 90, lineheight = .75) +
  annotate("text", x = 1, y = 0.99, label = paste0("of~CO[2]"), size = 3.1, family = "Arial", color = "grey76", hjust = 1.5, vjust = 2.45, parse = TRUE, angle = 90, lineheight = .75) +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_continuous(limits = c(0, 1))

ggsave(here("images", "cumulative-emissions-region-1990-2018.svg"), device="svg", dpi=300)
```

```{r treemaps emissions annual, warning=FALSE, message=FALSE}
gcp_long %>%
  filter(year == "2019") %>%
  ggplot(aes(area = co2_gcp, fill = region, subgroup = region)) +
  geom_treemap() +
  geom_treemap_subgroup_border(size = 1) +
  scale_fill_brewer(palette = "Greens") +
#  scale_fill_hue(l=40, c=35) +
#  geom_treemap_subgroup_text(grow = FALSE, place = "centre", size = 12, color = "black", reflow = TRUE) +
  theme_void() + 
  theme(legend.position = "none") +
  annotate("text", x = 0.165, y = 0.32, label = "East Asia & Pacific", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.165, y = 0.28, label = paste0("14.4~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey46", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.15, y = 0.88, label = "Europe & Central Asia", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.15, y = 0.84, label = paste0("6.44~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey46", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.74, y = 0.20, label = "North America", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.74, y = 0.16, label = paste0("5.86~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey36", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.61, y = 0.84, label = "Middle East &\nNorth Africa", size = 4.5, family = "Arial", color = "grey20", lineheight = .75, hjust = 0) +
  annotate("text", x = 0.61, y = 0.78, label = paste0("2.83~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey36", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.76, y = 0.53, label = "South Asia", size = 4.5, family = "Arial", color = "grey20", hjust = 0) +
  annotate("text", x = 0.76, y = 0.49, label = paste0("3.02~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey30", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.845, y = 0.80, label = "Latin America &\nCaribbean", size = 4.5, family = "Arial", color = "grey20", hjust = 0, lineheight = .75) +
  annotate("text", x = 0.845, y = 0.74, label = paste0("1.70~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey36", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.845, y = 0.98, label = "Sub-\nSaharan\nAfrica", size = 4, family = "Arial", color = "grey77", lineheight = .75, hjust = 0) +
  annotate("text", x = 0.913, y = 0.92, label = paste0("0.89~Gt~of~CO[2]"), size = 3.1, family = "Arial", color = "grey76", hjust = 0, vjust = 0, parse = TRUE, lineheight = .75) +
#  annotate("text", x = 0.95, y = 0.99, label = paste0("of~CO[2]"), size = 3.1, family = "Arial", color = "grey76", hjust = 1.5, vjust = 2.45, parse = TRUE, angle = 90, lineheight = .75) +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_continuous(limits = c(0, 1))

ggsave(here("images", "annual-emissions-region-2019.svg"), device="svg", dpi=300)
```


```{r treemaps vulnerability, warning=FALSE, message=FALSE}
vulnerability_all %>%
  ggplot(aes(area = total_affected_cumulative, fill = region, subgroup = region)) +
  geom_treemap() +
  geom_treemap_subgroup_border(size = 0) +
  scale_fill_brewer(palette = "Greens") +
#  scale_fill_hue(l=40, c=35) +
#  geom_treemap_subgroup_text(grow = FALSE, place = "centre", size = 12, color = "black", reflow = TRUE) +
  theme_void() + 
  theme(legend.position = "none") +
  annotate("text", x = 0.17, y = 0.51, label = "East Asia & Pacific", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.17, y = 0.47, label = paste0("3.34 bil (58.12%)"), size = 3.75, family = "Arial", color = "grey46", hjust = 0) +
  annotate("text", x = 0.95, y = 1, label = "Europe &\nCentral Asia", size = 3, family = "Arial", color = "grey26", hjust = 0, lineheight = .75, vjust = 0.1) +
  annotate("text", x = 0.945, y = 0.98, label = paste0("44.6 mil (0.78%)"), size = 2.25, family = "Arial", color = "grey46", hjust = 0) +
  annotate("text", x = 0.83, y = 0.95, label = "North\nAmerica", size = 4, family = "Arial", color = "grey20", hjust = 0, lineheight = .75) +
  annotate("text", x = 0.825, y = 0.9, label = paste0("114 mil (1.98%)"), size = 3, family = "Arial", color = "grey36", hjust = 0) +
  annotate("text", x = 0.95, y = 0.915, label = "Middle East\n& North\nAfrica", size = 3, family = "Arial", color = "grey20", lineheight = .75, hjust = 0) +
  annotate("text", x = 0.925, y = 0.85, label = paste0("51.2 mil (0.89%)"), size = 3, family = "Arial", color = "grey36", hjust = 0) +
  annotate("text", x = 0.76, y = 0.33, label = "South Asia", size = 5, family = "Arial", color = "grey20", hjust = 0) +
  annotate("text", x = 0.76, y = 0.29, label = paste0("1.66 bil (28.93%)"), size = 3.75, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.83, y = 0.785, label = "Latin America &\nCaribbean", size = 4.5, family = "Arial", color = "grey20", hjust = 0, lineheight = .75) +
  annotate("text", x = 0.83, y = 0.735, label = paste0("166 mil (2.89%)"), size = 3.75, family = "Arial", color = "grey36", hjust = 0) +
  annotate("text", x = 0.6, y = 0.7935, label = "Sub-\nSaharan\nAfrica", size = 5, family = "Arial", color = "grey77", lineheight = .75, hjust = 0) +
  annotate("text", x = 0.6, y = 0.725, label = paste0("369 mil (6.41%)"), size = 3.15, family = "Arial", color = "grey76", hjust = 0, vjust = 1.45) +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_continuous(limits = c(0, 1))

ggsave(here("images", "cumulative-affected-region-1990-2018.svg"), device="svg", dpi=300)
```


## Session Info

Below is the session information, which include the version of R, loaded packages, and platforms used. This is helpful to know when conducting replications for data and analysis

```{r}
sessionInfo()
```

<!--## References-->


```{r export as an R script, eval=FALSE, message=FALSE, warning=FALSE}
knitr::purl("Vulnerability-Data-Analysis.Rmd", "Vulnerability-Data-Analysis.R")
knitr::write_bib(.packages(), "packages.bib")
```
