---
title: "Vulnerability Data Analysis"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document:
    reference_docx: ../templates/template.docx
  pdf_document: default
  html_document:
    df_print: paged
bibliography: ../bibliography/climate-change.bib
suppress-bibliography: true
csl: ../bibliography/chicago-fullnote-bibliography-with-ibid.csl
always_allow_html: true
---

In this exercise, we will explore SDG's 13.1.1 indicator, [XXX], associated with target 13.1, [XXX]. The indicator's associated data is from the Emergency Events Database (EM-DAT), managed by the Centre for Research on the Epidemiology of Disasters (CRED) [-@CRED2021].

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      purl = TRUE,
                      out.extra = '',
                      knitr.duplicate.label = "allow",
                      tidy.opts = list(width.cutoff = 40), 
                      tidy = TRUE,
                      strip.white = FALSE)

```

## Load libraries

First, we need to load the following libraries:

```{r libraries, message=FALSE, warning=FALSE}
library(readxl)
library(here)
library(tidyverse)
library(janitor)
library(scales)
library(viridis)
library(hrbrthemes)
library(kableExtra)
library(ggrepel)
library(treemapify)
library(extrafont)
loadfonts(device = "win")
```

## Download the dataset

You can access the full database [here](https://public.emdat.be/) by submitting a query for the data you need. You will need to register with the database first before you can submit a query. For the purpose of this exercise, we will provide you with the full dataset that starts from 1900. This dataset is as of March 24, 2021.

## Import dataset

Using the package `readxl` we can import the dataset that's in Excel format. If you preview the raw file in Excel, you will find that the first six rows are used as description of the dataset, therefore we need to make sure that R does not read rows that are not part of the dataset. The function `read_excel` provides a convenient option called `skip`, which tells R how many rows to skip before reading the dataset. In this case, we need to skip six rows.

```{r}
em_dat <- readxl::read_excel(here::here("archive/EM-DAT", "emdat-public-2021-03-24-query-uid-DuX1xq-raw.xlsx"),
                     skip = 6)
```

## Clean dataset

Using the `janitor` package, we can use the function `clean_names` to create consistent-looking variable names.

```{r}
em_dat <- janitor::clean_names(em_dat)
```

Instead of recreating the object `em_dat` again, we can combine the previous two functions using the 'pipe' operator, `%>%`, which is loaded with the `tidyverse` package. This operator uses the previous output as the new input of the subsequent function.

```{r import em-dat dataset, warning=FALSE, message=FALSE}
em_dat <- readxl::read_excel(here::here("archive/EM-DAT", "emdat-public-2021-03-24-query-uid-DuX1xq-raw.xlsx"), skip = 6) %>%
          janitor::clean_names() 
```

In the above code chunk, we did the following:

1.  Imported the dataset using `read_excel` function.
2.  Took that dataset and cleaned all the variables' names using the `clean_names` function.
3.  Called the output of the previous two processes `em_dat`.

The `pipe` operator is a powerful function that can reduce the amount of code you need to write.

```{r select variables, warning=FALSE, message=FALSE}
em_dat_sub <- em_dat %>% 
  dplyr::select(iso, country, year, disaster_type, total_deaths, no_injured, no_affected, no_homeless, total_affected, total_damages_000_us) %>% 
  dplyr::filter(str_detect(disaster_type, "Drought|Extreme temperature|Flood|Storm|Wildfire"))
```

From 1900 to 2021, `r percent(nrow(em_dat_sub)/nrow(em_dat), accuracy = 0.1)` of recorded disaster events are from the following types: Drought, Extreme temperature, Flood, Storm, and Wildfire. Furthermore, within the same time frame, `r percent(sum(em_dat_sub$total_deaths, na.rm=TRUE)/sum(em_dat$total_deaths, na.rm=TRUE), accuracy = 0.1)` of total deaths are attributed to the disaster types that are more exacerbated by climate change. As for people affected by these disaster, approximately `r percent(sum(em_dat_sub$total_affected, na.rm=TRUE)/sum(em_dat$total_affected, na.rm=TRUE), accuracy = 0.1)` are because of these five types of climate-related disasters.

```{r plot disasters over time, warning=FALSE, message=FALSE}
em_dat_sub %>% 
  dplyr::select(-country, -iso) %>%
  dplyr::filter(as.numeric(year) >= 1990) %>% 
  dplyr::group_by(year, disaster_type) %>% 
  dplyr::summarise_all(funs(sum), na.rm = TRUE) %>%
  ggplot2::ggplot(aes(x = year, y = total_affected, fill = disaster_type, group = disaster_type)) +
  ggplot2::geom_area(alpha=0.6 , size=.3, colour="white", position = "identity") +
  viridis::scale_fill_viridis(name = "Disaster type", discrete = TRUE) +
  hrbrthemes::theme_ipsum(base_size = 11) + 
  ggplot2::scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6)) +
  ggplot2::ylab("Number of people affected") + 
  ggplot2::scale_x_discrete(name ="Year", breaks = seq(1990,2021,5)) +
  ggplot2::theme(text = element_text(family = "Arial", size = 11), 
                 axis.title.x = element_text(family = "Arial", size = 12), 
                 axis.title.y = element_text(family = "Arial", size = 12), 
                 legend.text = element_text(family = "Arial", size=11))

ggplot2::ggsave(here("images", "vulnerability-01.svg"), device="svg", dpi=300)
```

```{r em-dat sub for merging, warning=FALSE, message=FALSE}
em_dat_climate <- em_dat_sub %>% 
  dplyr::filter(as.numeric(year) >= 1990 & 
                  !(is.na(total_deaths) & 
                      is.na(no_injured) & 
                      is.na(no_affected) & 
                      is.na(no_homeless) & 
                      is.na(total_affected) & 
                      is.na(total_damages_000_us))) %>% 
  dplyr::group_by(iso, country, year, disaster_type) %>%
  dplyr::summarise_all(funs(sum), na.rm = TRUE) %>%
  dplyr::mutate(country = str_remove(country, " \\(the\\)")) %>%
  dplyr::mutate(country = str_replace_all(country, c("Korea \\(the Republic of\\)" = "Republic of Korea",
                                                     "Congo \\(the Democratic of\\)" = "Democratic Republic of the Congo",
                                                     "Tanzania, United Republic of" = "United Republic of Tanzania",
                                                     "Taiwan \\(Province of China\\)" = "China"))) %>%
  dplyr::na_if(., 0)

utils::write.csv(em_dat_climate, "em-dat-total-climate-affected-clean.csv", row.names = FALSE)

rm(em_dat, em_dat_climate, em_dat_sub)
```

Here we sum over disaster data by disaster type, year, and country. For example, we count all the damages that occurred in Bangladesh for the year 2018 by floods.


## Import UNFCCC emissions data

```{r import clean dataset, warning=FALSE, message=FALSE}
unfccc_emissions <- utils::read.csv(here::here("scripts/cleaning", "unfccc-emissions-clean.csv"), stringsAsFactors = TRUE)
```

## merge with EM-DAT

```{r sum totals, warning=FALSE, message=FALSE}
em_dat_climate <- utils::read.csv(here::here("archive", "em-dat-total-climate-affected-clean.csv"), stringsAsFactors = TRUE)

totals <- em_dat_climate %>% 
  dplyr::ungroup() %>% 
  dplyr::select(!c(disaster_type, no_injured, no_affected, no_homeless)) %>%
  dplyr::group_by(iso, country, year) %>%
  dplyr::summarise_all(funs(sum), na.rm = TRUE) %>%
  dplyr::na_if(., 0)
```

We need to ungroup data before we remove any variables, otherwise it wouldn't work. Here we are summing over all types of disasters by countries and year so we can compare them by emissions.

```{r merge two datasets, warning=FALSE, message=TRUE}
vulnerability <- unfccc_emissions %>% 
  dplyr::filter(year != "base_year", type != "Total GHG emissions with LULUCF") %>%
  fuzzyjoin::regex_left_join(totals, by = c("year" = "year", "iso" = "iso")) %>%
  dplyr::select(-year.y, -iso.y, -country.y, -type) %>%
  dplyr::rename("year" = "year.x", "iso" = "iso.x", "country" = "country.x", "co2_unfccc" = "co2")

rm(totals, em_dat_climate)
```

Now we have a dataset that includes UNFCCC GHG emissions without Land Use, Land-Use Chang and Forestry (LULUCF) and people affected as a result of climate-related disasters. We chose to exclude LULUCF from the analysis because we wanted to measure gross emissions instead of net emissions, which can be misleading especially for well-endowed carbon sinks nations.

## Data exploration

We need to check for all the missing values, especially for Non-Annex I parties' GHG inventories because they are voluntary submissions. First, we will check the degree of missing values for Annex I and Non-Annex I countries, starting with Non-Annex I countries.

```{r check NAs CO2 non-annex, warning=FALSE, message=FALSE, caption = "Percent of missing values of CO~2~ over time (Non-Annex I)"}
missing_non_annex_i_year <- vulnerability %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(group == "Non-Annex I") %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(missing = round(sum(is.na(co2))/length(co2) * 100, digits = 2))
  
kableExtra::kbl(list(missing_non_annex_i_year[1:10, ], missing_non_annex_i_year[11:20, ], missing_non_annex_i_year[21:30, ])) %>% 
  kableExtra::kable_classic(full_width = FALSE)
```

As we can see the data deprivations are quite stark when it comes to reporting data on GHG and CO~2~ emissions for most developing countries. There are only two years where data reporting exceeds 50% of the official members: 1994, and 2000.

```{r check NAs CO2 annex, warning=FALSE, message=FALSE, caption = "Percent of missing values of CO~2~ over time (Annex I)"}
missing_annex_i_year <- vulnerability %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(group == "Annex I") %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(missing = round(sum(is.na(co2))/length(co2) * 100, digits = 2))

kableExtra::kbl(list(missing_annex_i_year[1:10, ], missing_annex_i_year[11:20, ], missing_annex_i_year[21:30, ])) %>%
  kableExtra::kable_classic(full_width = FALSE)
```
The story is not the same for Annex I countries because reporting GHG and CO~2~ emission inventories is mandatory within the UNFCCC.


```{r check NAs CO2 by region non-annex, warning=FALSE, message=FALSE}
missing_non_annex_i_region <- vulnerability %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(group == "Non-Annex I") %>%
  dplyr::mutate(time_period = floor(as.numeric(as.character(year))/10)*10) %>%
  dplyr::group_by(time_period, region) %>%
  dplyr::summarise(missing = sum(is.na(co2_unfccc))/length(co2_unfccc) * 100) %>%
  dplyr::mutate(time_period = as.factor(time_period))
  
missing_non_annex_i_region$time_period <- dplyr::recode_factor(missing_non_annex_i_region$time_period, `1990` = "1990-1999", `2000` = "2000-2009", `2010` = "2010-2018")
```


```{r barplot by decade Non-Annex I, warning=FALSE, message=FALSE, caption = "Percent of missing values of CO~2~ by region (Non-Annex I)"}
missing_non_annex_i_region %>%
  ggplot2::ggplot(aes(x = time_period, y = missing, fill = region)) +
  ggplot2::geom_bar(stat="identity", position=position_dodge(), color = "black") +
  ggplot2::theme_classic() +
  ggplot2::ylab("Missing Values (%)") +
  ggplot2::xlab("Years") +
  ggplot2::coord_flip() +
  ggplot2::scale_fill_brewer(palette = "Paired", name = "Regions") +
  ggplot2::geom_text(aes(label = round(missing, digits = 0)), position=position_dodge(width=0.9), hjust = -0.25) +
  ggplot2::theme(text=element_text(family = "Arial", size = 11), 
                 axis.title.x = element_text(family = "Arial", size = 12), 
                 axis.title.y = element_text(family = "Arial", size = 12), 
                 legend.text=element_text(family = "Arial", size=11))

ggsave(here("images", "missing-non-annex-i-01.svg"), device="svg", dpi=300)  
```

We can see that many Non-Annex I party submit their GHG inventories the least which makes it difficult to aggregate their cumulative emissions, with the highest levels of missing values located in Africa and Oceania. We will use data from the Global Carbon Project to calculate cumulative CO~2~ based on their estimates.

## Data Analysis

In this section we will explore how different data transformations can produce different conclusions. We will look at three different transformations: cumulative, average, and capita measures. Cumulative transformations add up all the values based on a category. For this exercise we will calculate the cumulative emissions and vulnerabilities over *time*, i.e. from 1990 to 2018. 

Average estimates is just that: the average emissions for a given period. The one most of us know about is the arithmetic average, which adds up all the values and divides them by the count of values, so in this instance we will add up the number of emissions and vulnerabilities over time and divide them by the number of years in the dataset which is 29 years. This type of average is not recommended for time-related data because it gives equal capita for all years and does not capture changes over time. There are methods that deal with this issue but it is beyond the scope of this textbook.

Finally, we can use weighting methods to add more perspective to our data and makes our data a little more standardized. For example, we can use population data to normalize emissions and vulnerabilities, meaning we can measure emissions and vulnerabilities per 100,000 people (which demographers call it rate) that way it makes it easier to compare countries with large populations to smaller ones.

In this part of the module, we will explore the three different measures, and disaggregate them by country and region.

### UNFCCC data

First, let's calculate the cumulative, average, and capita emissions and vulnerabilities for each country based on the UNFCCC and EM-DAT data:

```{r unfccc cumulative and mean co2, warning=FALSE, message=FALSE}
vulnerability_cumulative <- vulnerability %>%
  dplyr::ungroup() %>%
  dplyr::select(-ghg, -year) %>%
  dplyr::group_by(iso, country, region, group) %>%
  dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_cumulative")}, where(is.numeric))

vulnerability_mean <- vulnerability %>%
  dplyr::ungroup() %>%
  dplyr::select(-ghg, -year) %>%
  dplyr::group_by(iso, country, region, group) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_average")}, where(is.numeric))
```

This will add up and average all the deaths, injuries, affected, and damages for each country from 1990 to 2021, and all the CO~2~ emissions from 1990-2018.

To add a population capita value to emissions and vulnerabilities, we first need to import population data and merge it with our `vulnerability` dataset. We will use the [population dataset](https://datahub.io/core/population) that's been sourced from several sources. This dataset is in long format, and the population is measured in raw count, which is total people. After weighting the emissions and climate vulnerabilities, we again calculate the cumulative and the average for each variable separately

```{r population capita co2, warning=FALSE, message=FALSE}
download.file("https://datahub.io/core/population/r/population.csv", "population.csv")

pop <- utils::read.csv("population.csv", stringsAsFactors = TRUE) %>% 
  janitor::clean_names() %>%
  filter(year >= 1990) %>%
  mutate(year = as.factor(year)) %>%
  dplyr::rename("population" = "value") 

vulnerability_capita <- vulnerability %>%
  dplyr::ungroup() %>%
  dplyr::select(-ghg) %>%
  dplyr::left_join(pop, by = c("year" = "year", "iso" = "country_code")) %>%
  dplyr::select(-country_name) %>%
  dplyr::mutate_if(is.numeric, funs(. / population)) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_capita")}, where(is.numeric))
```

Next, we will calculate both the capita cumulative and capita average to see any difference.

```{r unfccc capita cumulative and mean co2, warning=FALSE, message=FALSE}
vulnerability_cumulative_capita <- vulnerability_capita %>%
  dplyr::ungroup() %>%
  select(-population_capita) %>%
  dplyr::group_by(iso, country, region, group) %>%
  dplyr::select_if(is.numeric) %>%
  dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_cumulative")}, where(is.numeric))

vulnerability_mean_capita <- vulnerability_capita %>%
  dplyr::ungroup() %>%
  select(-population_capita) %>%
  dplyr::group_by(iso, country, region, group) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_average")}, where(is.numeric))
```

```{r merge all, warning=FALSE, message=TRUE}
vulnerability_all <- vulnerability_cumulative %>%
  dplyr::left_join(vulnerability_mean, by = c("iso" = "iso", "country" = "country", "region" = "region", "group" = "group")) %>%
  dplyr::left_join(vulnerability_cumulative_capita, by = c("iso" = "iso", "country" = "country", "region" = "region", "group" = "group")) %>%
  dplyr::left_join(vulnerability_mean_capita, by = c("iso" = "iso", "country" = "country", "region" = "region", "group" = "group"))

rm(vulnerability_cumulative, vulnerability_cumulative_capita, vulnerability_mean, vulnerability_mean_capita, vulnerability_capita)
```


### Global Carbon Project data

We will first import the Global Carbon Project dataset, then convert into the long format.

```{r import dataset, warning=FALSE, message=FALSE}
gcp <- readxl::read_excel(here::here("archive/Global-Carbon-Project", "National-Carbon-Emissions-2020-v1.0-raw.xlsx"), 
                          sheet = 2, 
                          skip = 11, 
                          na = "NaN") %>%
  dplyr::rename(year = `...1`)
```

GCP publishes its data in million tonnes of fossil carbon. To convert it to kt of CO~2~ we need to multiply it by 3664 [@Friedlingstein2020].

```{r reshape dataset, warning=FALSE, message=FALSE}
gcp_long <- gcp %>%
  dplyr::filter(year >= 1990) %>%
  tidyr::gather(country, co2_gcp, Afghanistan:World) %>%
  dplyr::mutate(co2_gcp = 3664 * co2_gcp, year = as.factor(year))

region <- countrycode::codelist %>% 
  dplyr::select(country.name.en, region, iso3c) %>% 
  dplyr::mutate(country.name.en = stringr::str_replace_all(country.name.en, 
                                                      c("Antigua & Barbuda" = "Antigua and Barbuda", 
                                                        "Bosnia & Herzegovina" = "Bosnia and Herzegovina",
                                                        "Congo - Kinshasa" = "Congo", 
                                                        "Côte d’Ivoire" = "Côte d'Ivoire", 
                                                        "Congo - Brazzaville" = "Democratic Republic of Congo",
                                                        "Czechia" = "Czech Republic",
                                                        "Faroe Islands" = "Faeroe Islands",
                                                        "Hong Kong SAR China" = "Hong Kong",
                                                        "Macao SAR China" = "Macao",
                                                        "Micronesia \\(Federated States of\\)" = "Micronesia",
                                                        "Myanmar \\(Burma\\)" = "Myanmar",
                                                        "St. Lucia" = "Saint Lucia",
                                                        "St. Vincent & Grenadines" = "Saint Vincent and the Grenadines",
                                                        "São Tomé & Príncipe" = "Sao Tome and Principe",
                                                        "Palestinian Territories" = "Occupied Palestinian Territory",
                                                        "Trinidad & Tobago" = "Trinidad and Tobago",
                                                        "Eswatini" = "Swaziland",
                                                        "Turks & Caicos Islands" = "Turks and Caicos Islands",
                                                        "United States" = "USA",
                                                        "Wallis & Futuna" = "Wallis and Futuna Islands",
                                                        "St. Kitts & Nevis" = "Saint Kitts and Nevis",
                                                        "St. Helena" = "Saint Helena",
                                                        "St. Pierre & Miquelon" = "Saint Pierre and Miquelon",
                                                        "Vietnam" = "Viet Nam")))

region$region[region$country.name.en == "Taiwan"] <- "East Asia & Pacific"

gcp_long <- gcp_long %>% 
  fuzzyjoin::regex_left_join(region, by = c(country = "country.name.en")) %>%
  dplyr::rename(iso = iso3c) %>%  
  dplyr::filter(!(country == "United Kingdom of Great Britain and Northern Ireland" & iso == "IRL"),
                !(country == "Guinea-Bissau" & iso == "GIN"),
                !(country == "Papua New Guinea" & iso == "GIN"),
                !(country == "Democratic People's Republic of Korea" & iso == "KOR"),
                !(country == "Dominican Republic" & iso == "DMA"),
                !(country == "Nigeria" & iso == "NER"),
                !(country == "South Sudan" & iso == "SDN")) %>%
  filter(!is.na(region)) %>%
  select(-country.name.en) %>%
  relocate(iso, .before = country) %>%
  relocate(region, .after = country) %>%
  relocate(year, .after = region)

utils::write.csv(gcp_long, "gcp-long-clean.csv", row.names = FALSE)

rm(region)
```

Here we will calculate the cumulative, average and population-capita estimates.

```{r aggregate dataset, warning=FALSE, message=FALSE}
gcp_cumulative <- gcp_long %>%
  dplyr::ungroup() %>%
  dplyr::filter(!str_detect('KP Annex B | Non KP Annex B | OECD | Non-OECD | EU27 | Africa | Asia | Central America | Europe | Middle East | North America | Oceania | South America | Bunkers | World | Statistical Difference', country)) %>%
  dplyr::group_by(iso, country, region) %>%
  dplyr::summarize(co2_gcp = sum(co2_gcp, na.rm = TRUE)) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_cumulative")}, where(is.numeric))

gcp_mean <- gcp_long %>%
  dplyr::ungroup() %>%
  dplyr::filter(!str_detect('KP Annex B | Non KP Annex B | OECD | Non-OECD | EU27 | Africa | Asia | Central America | Europe | Middle East | North America | Oceania | South America | Bunkers | World | Statistical Difference', country)) %>%
  dplyr::group_by(iso, country, region) %>%
  dplyr::summarize(co2_gcp = mean(co2_gcp, na.rm = TRUE)) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_average")}, where(is.numeric))

gcp_capita <- gcp_long %>%
  dplyr::ungroup() %>%
  dplyr::filter(!str_detect('KP Annex B | Non KP Annex B | OECD | Non-OECD | EU27 | Africa | Asia | Central America | Europe | Middle East | North America | Oceania | South America | Bunkers | World | Statistical Difference', country)) %>%
  dplyr::left_join(pop, by = c("year" = "year", "iso" = "country_code")) %>%
  select(-country_name) %>%
  dplyr::mutate(co2_gcp =  co2_gcp / population) %>%
  relocate(iso, .before = country) %>%
  relocate(year, .after = region) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_capita")}, where(is.numeric))

gcp_cumulative_capita <- gcp_capita %>%
  dplyr::ungroup() %>%
  select(-population_capita) %>%
  dplyr::group_by(iso, country, region) %>%
  dplyr::summarise_if(is.numeric, sum, na.rm = TRUE) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_cumulative")}, where(is.numeric))

gcp_mean_capita <- gcp_capita %>%
  dplyr::ungroup() %>%
  select(-population_capita) %>%
  dplyr::group_by(iso, country, region) %>%
  dplyr::summarise_if(is.numeric, mean, na.rm = TRUE) %>%
  dplyr::rename_with(., .fn = function(x){paste0(x, "_average")}, where(is.numeric))

gcp_all <- gcp_cumulative %>%
  dplyr::left_join(gcp_mean, by = c("iso" = "iso", "country" = "country", "region" = "region")) %>%
  dplyr::left_join(gcp_cumulative_capita, by = c("iso" = "iso", "country" = "country", "region" = "region")) %>%
  dplyr::left_join(gcp_mean_capita, by = c("iso" = "iso", "country" = "country", "region" = "region"))
  
rm(gcp_cumulative, gcp_mean, gcp_cumulative_capita, gcp_mean_capita, gcp_capita, pop)
```


```{r merge gcp cumulative with vulnerability cumulative, warning = FALSE, message=FALSE}
vulnerability_all <- vulnerability_all %>%
  dplyr::left_join(gcp_all, by = c("iso" = "iso", "region" = "region")) %>%
  na_if(., 0) %>% 
  na_if(., "NaN") %>%
  ungroup() %>%
  mutate(status_cumulative = case_when(co2_gcp_cumulative >= quantile(co2_gcp_cumulative, 0.9, na.rm = TRUE) ~ '90th percentile emitter', total_affected_cumulative >= quantile(total_affected_cumulative, 0.9, na.rm = TRUE) ~ '90th percentile affected'), status_average = case_when(co2_gcp_average >= quantile(co2_gcp_average, 0.9, na.rm = TRUE) ~ '90th percentile emitter', total_affected_average >= quantile(total_affected_average, 0.9, na.rm = TRUE) ~ '90th percentile affected'), status_capita_cumulative = case_when(co2_gcp_capita_cumulative >= quantile(co2_gcp_capita_cumulative, 0.9, na.rm = TRUE) ~ '90th percentile emitter', total_affected_capita_cumulative >= quantile(total_affected_capita_cumulative, 0.9, na.rm = TRUE) ~ '90th percentile affected'), status_capita_average = case_when(co2_gcp_capita_average >= quantile(co2_gcp_capita_average, 0.9, na.rm = TRUE) ~ '90th percentile emitter', total_affected_capita_average >= quantile(total_affected_capita_average, 0.9, na.rm = TRUE) ~ '90th percentile affected')) %>%
  dplyr::filter(!(country.x == "Congo" & country.y == "Democratic Republic of the Congo"),
                !(country.x == "Democratic Republic of the Congo" & country.y == "Congo"),
                !(country.x == "Guinea" & country.y == "Equatorial Guinea")) %>%
  select(-country.y) %>%
  rename("country" = "country.x")

utils::write.csv(vulnerability_all, "emissions-vulnerability-cumulative-clean.csv", row.names = FALSE)
```


```{r plot vulnerability versus emissions (cumulative with outliers), warning=FALSE, message=FALSE, caption = "Cumulative emissions and climate-related vulnerabilites (1990-2018)"}
vulnerability_all %>%
  drop_na(total_affected_cumulative) %>%
  ggplot2::ggplot(aes(x = co2_gcp_cumulative, y = total_affected_cumulative, color = region)) +
  ggplot2::geom_point(size = 3, alpha = 0.75) + 
  theme_minimal() +
  ggplot2::scale_y_continuous(labels = unit_format(unit = "B", scale = 1e-9)) + 
  ggplot2::scale_x_continuous(labels = unit_format(unit = "", scale = 1e-6)) +
  geom_text_repel(aes(label=ifelse(co2_gcp_cumulative >= quantile(co2_gcp_cumulative, 0.9, na.rm = TRUE), as.character(iso),'')), show.legend = FALSE, color = "black", size = 3.5) +
  xlab(expression(CO[2]~(Gt))) +
  ylab("Total affected people") +
  ggplot2::scale_color_brewer(palette = "Paired", name = "Regions") +
  ggplot2::theme(text=element_text(family = "Arial", size = 11), 
                 axis.title.x = element_text(family = "Arial", size = 12), 
                 axis.title.y = element_text(family = "Arial", size = 12), 
                 legend.text=element_text(family = "Arial", size=11))
```

```{r plot vulnerability versus emissions (cumulative without outliers), warning=FALSE, message=FALSE, caption = "Cumulative emissions and climate-related vulnerabilites (1990-2018)"}
vulnerability_all %>%
  drop_na(total_affected_cumulative) %>%
  filter(!str_detect('China | United States of America | India | Russian Federation', as.character(country))) %>%
  ggplot2::ggplot(aes(x = co2_gcp_cumulative, y = total_affected_cumulative, color = region)) +
  ggplot2::geom_point(size = 3, alpha = 0.75) + 
  theme_minimal() +
  ggplot2::scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6)) + 
  ggplot2::scale_x_continuous(labels = unit_format(unit = "", scale = 1e-6)) +
  geom_text_repel(aes(label=ifelse(co2_gcp_cumulative >= quantile(co2_gcp_cumulative, 0.9, na.rm = TRUE), as.character(iso),'')), show.legend = FALSE, color = "black", size = 3.5) +
  geom_text_repel(aes(label=ifelse(total_affected_cumulative >= quantile(total_affected_cumulative, 0.9, na.rm = TRUE), as.character(iso),'')), show.legend = FALSE, color = "black", size = 3.5) +
  xlab(expression(CO[2]~(Gt))) +
  ylab("Total affected people") +
  ggplot2::scale_color_brewer(palette = "Paired", name = "Regions") +
  ggplot2::theme(text=element_text(family = "Arial", size = 11), 
                 axis.title.x = element_text(family = "Arial", size = 12), 
                 axis.title.y = element_text(family = "Arial", size = 12), 
                 legend.text=element_text(family = "Arial", size=11))
```

```{r plot vulnerability versus emissions (average with outliers), warning=FALSE, message=FALSE, caption = "Mean emissions and climate-related vulnerabilites (1990-2018)"}
vulnerability_all %>%
  drop_na(total_affected_average) %>%
  ggplot2::ggplot(aes(x = co2_gcp_average, y = total_affected_average, color = region)) +
  ggplot2::geom_point(size = 3, alpha = 0.75) + 
  theme_minimal() +
  ggplot2::scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6)) + 
  ggplot2::scale_x_continuous(labels = unit_format(unit = "", scale = 1e-6)) +
  geom_text_repel(aes(label=ifelse(co2_gcp_average >= quantile(co2_gcp_average, 0.9, na.rm = TRUE),as.character(iso),'')), show.legend = FALSE, color = "black", size = 3.5) +
  xlab(expression(CO[2]~(Gt))) +
  ylab("Total affected people") +
  ggplot2::scale_color_brewer(palette = "Paired", name = "Regions") +
  ggplot2::theme(text=element_text(family = "Arial", size = 11), 
                 axis.title.x = element_text(family = "Arial", size = 12), 
                 axis.title.y = element_text(family = "Arial", size = 12), 
                 legend.text=element_text(family = "Arial", size=11))
```

```{r plot vulnerability versus emissions (capita cumulative), warning=FALSE, message=FALSE, caption = "Cumulative emissions and average climate-related vulnerabilites capita by population (1990-2018)"}
vulnerability_all %>%
  drop_na(total_affected_capita_average) %>%
  ggplot2::ggplot(aes(x = co2_gcp_capita_cumulative, y = total_affected_capita_cumulative, color = region)) +
  ggplot2::geom_point(size = 3, alpha = 0.75) + 
  theme_minimal() +
#  ggplot2::scale_y_continuous(labels = unit_format(unit = "", scale = 1e-3)) + 
#  ggplot2::scale_x_continuous(labels = unit_format(unit = "", scale = 1e-3)) +
  geom_text_repel(aes(label=ifelse(co2_gcp_capita_cumulative >= quantile(co2_gcp_capita_cumulative, 0.9, na.rm = TRUE), as.character(country),'')), show.legend = FALSE, color = "black", size = 3) +
  geom_text_repel(aes(label=ifelse(total_affected_capita_average >= quantile(total_affected_capita_average, 0.9, na.rm = TRUE), as.character(country),'')), show.legend = FALSE, color = "black", size = 3) +
  xlab(expression(CO[2]~(kt))) +
  ylab("Total affected people") +
  ggplot2::scale_color_brewer(palette = "Paired", name = "Regions") +
  ggplot2::theme(text=element_text(family = "Arial", size = 11), 
                 axis.title.x = element_text(family = "Arial", size = 12), 
                 axis.title.y = element_text(family = "Arial", size = 12), 
                 legend.text=element_text(family = "Arial", size=11))
```

```{r plot vulnerability versus emissions (capita average), warning=FALSE, message=FALSE, caption = "Cumulative emissions and climate-related vulnerabilites capita by population (1990-2018)"}
vulnerability_all %>%
  drop_na(total_affected_capita_average) %>%
  ggplot2::ggplot(aes(x = co2_gcp_capita_average, y = total_affected_capita_average, color = region)) +
  ggplot2::geom_point(size = 3, alpha = 0.75) + 
  theme_minimal() +
#  ggplot2::scale_y_continuous(labels = unit_format(unit = "", scale = 1e-3)) + 
#  ggplot2::scale_x_continuous(labels = unit_format(unit = "", scale = 1e-3)) +
  geom_text_repel(aes(label=ifelse(co2_gcp_capita_cumulative >= quantile(co2_gcp_capita_cumulative, 0.9, na.rm = TRUE), as.character(iso),'')), show.legend = FALSE, color = "black", size = 3.5) +
  geom_text_repel(aes(label=ifelse(total_affected_capita_cumulative >= quantile(total_affected_capita_cumulative, 0.9, na.rm = TRUE), as.character(iso),'')), show.legend = FALSE, color = "black", size = 3.5) +
  xlab(expression(CO[2]~(kt))) +
  ylab("Total affected people (000s)") +
  ggplot2::scale_color_brewer(palette = "Paired", name = "Regions") +
  ggplot2::theme(text=element_text(family = "Arial", size = 11), 
                 axis.title.x = element_text(family = "Arial", size = 12), 
                 axis.title.y = element_text(family = "Arial", size = 12), 
                 legend.text=element_text(family = "Arial", size=11))
```

```{r top emitters and top affected minus outliers, message=FALSE, warning=FALSE, eval = FALSE}
top_emitters <- vulnerability_all %>%
  filter(!str_detect('China | USA | India | Russian Federation', country) & co2_gcp >= quantile(co2_gcp, 0.9, na.rm = TRUE)) %>%
  arrange(desc(co2_gcp)) %>%
  filter(!str_detect('Thailand', country))

top_affected <- vulnerability_all %>%
  filter(!str_detect('China | USA | India | Russian Federation', country) & total_affected >= quantile(total_affected, 0.9, na.rm = TRUE)) %>%
  arrange(desc(total_affected))
```


```{r top co2 emitters, warning=FALSE, message=FALSE}
vulnerability_all %>% 
  select(country, region, co2_gcp_cumulative, total_affected_cumulative) %>% 
  arrange(desc(co2_gcp_cumulative)) %>%
  top_frac(0.1, co2_gcp_cumulative) %>%
  mutate_each(funs(prettyNum(., big.mark=","))) %>%
  kbl(col.names = c("Country", "Region", "CO~2~", "Affected People")) %>% 
  kableExtra::kable_classic(full_width = FALSE)

vulnerability_all %>% 
  select(country, region, co2_gcp_cumulative, total_affected_cumulative) %>% 
  arrange(desc(total_affected_cumulative)) %>%
  top_frac(0.1, total_affected_cumulative) %>%
  mutate_each(funs(prettyNum(., big.mark=","))) %>%
  kbl(col.names = c("Country", "Region", "CO~2~", "Affected People")) %>% 
  kableExtra::kable_classic(full_width = FALSE)

vulnerability_all %>% 
  select(country, region, co2_gcp_capita_average, total_affected_capita_average) %>% 
  arrange(desc(co2_gcp_capita_average)) %>%
  top_frac(0.1, co2_gcp_capita_average) %>%
  mutate_each(funs(prettyNum(., big.mark=","))) %>%
  kbl(col.names = c("Country", "Region", "CO~2~", "Affected People")) %>% 
  kableExtra::kable_classic(full_width = FALSE)

vulnerability_all %>% 
  select(country, region, co2_gcp_capita_average, total_affected_capita_average) %>% 
  arrange(desc(total_affected_capita_average)) %>%
  top_frac(0.1, total_affected_capita_average) %>%
  mutate_each(funs(prettyNum(., big.mark=","))) %>%
  kbl(col.names = c("Country", "Region", "CO~2~", "Affected People")) %>% 
  kableExtra::kable_classic(full_width = FALSE)
```



## Visualizations


Here we will create two treemaps: one for cumulative emissions and another for cumulative affected people by climate-related disasters.

```{r treemaps emissions, warning=FALSE, message=FALSE}
vulnerability_all %>%
  ggplot(aes(area = co2_gcp_cumulative, fill = region, subgroup = region)) +
  geom_treemap() +
  geom_treemap_subgroup_border(size = 1) +
  scale_fill_brewer(palette = "Greens") +
#  scale_fill_hue(l=40, c=35) +
#  geom_treemap_subgroup_text(grow = FALSE, place = "centre", size = 12, color = "black", reflow = TRUE) +
  theme_void() + 
  theme(legend.position = "none") +
  annotate("text", x = 0.17, y = 0.26, label = "East Asia & Pacific", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.17, y = 0.22, label = paste0("275.8~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey46", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.17, y = 0.81, label = "Europe & Central Asia", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.17, y = 0.77, label = paste0("209.9~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey46", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.74, y = 0.26, label = "North America", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.74, y = 0.22, label = paste0("184.9~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey36", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.60, y = 0.68, label = "Middle East & North\nAfrica", size = 4.5, family = "Arial", color = "grey20", lineheight = .75, hjust = 0) +
  annotate("text", x = 0.60, y = 0.625, label = paste0("53.4~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey36", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.88, y = 0.69, label = "South Asia", size = 4.5, family = "Arial", color = "grey20", hjust = 0) +
  annotate("text", x = 0.88, y = 0.65, label = paste0("47.5~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey30", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.60, y = 0.95, label = "Latin America &\nCaribbean", size = 4.5, family = "Arial", color = "grey20", hjust = 0, lineheight = .75) +
  annotate("text", x = 0.60, y = 0.89, label = paste0("43.6~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey36", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.915, y = 0.925, label = "Sub-\nSaharan\nAfrica", size = 4, family = "Arial", color = "grey77", lineheight = .75, hjust = 0) +
  annotate("text", x = 1, y = 0.99, label = paste0("19.3~Gt"), size = 3.1, family = "Arial", color = "grey76", hjust = 1.4, vjust = 1.45, parse = TRUE, angle = 90, lineheight = .75) +
  annotate("text", x = 1, y = 0.99, label = paste0("of~CO[2]"), size = 3.1, family = "Arial", color = "grey76", hjust = 1.5, vjust = 2.45, parse = TRUE, angle = 90, lineheight = .75) +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_continuous(limits = c(0, 1))

ggsave(here("images", "cumulative-emissions-region-1990-2018.svg"), device="svg", dpi=300)
```

```{r treemaps emissions annual, warning=FALSE, message=FALSE}
gcp_long %>%
  filter(year == "2019") %>%
  ggplot(aes(area = co2_gcp, fill = region, subgroup = region)) +
  geom_treemap() +
  geom_treemap_subgroup_border(size = 1) +
  scale_fill_brewer(palette = "Greens") +
#  scale_fill_hue(l=40, c=35) +
#  geom_treemap_subgroup_text(grow = FALSE, place = "centre", size = 12, color = "black", reflow = TRUE) +
  theme_void() + 
  theme(legend.position = "none") +
  annotate("text", x = 0.165, y = 0.32, label = "East Asia & Pacific", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.165, y = 0.28, label = paste0("14.4~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey46", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.15, y = 0.88, label = "Europe & Central Asia", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.15, y = 0.84, label = paste0("6.44~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey46", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.74, y = 0.20, label = "North America", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.74, y = 0.16, label = paste0("5.86~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey36", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.61, y = 0.84, label = "Middle East &\nNorth Africa", size = 4.5, family = "Arial", color = "grey20", lineheight = .75, hjust = 0) +
  annotate("text", x = 0.61, y = 0.78, label = paste0("2.83~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey36", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.76, y = 0.53, label = "South Asia", size = 4.5, family = "Arial", color = "grey20", hjust = 0) +
  annotate("text", x = 0.76, y = 0.49, label = paste0("3.02~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey30", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.845, y = 0.80, label = "Latin America &\nCaribbean", size = 4.5, family = "Arial", color = "grey20", hjust = 0, lineheight = .75) +
  annotate("text", x = 0.845, y = 0.74, label = paste0("1.70~Gt~of~CO[2]"), size = 3.75, family = "Arial", color = "grey36", hjust = 0, parse = TRUE) +
  annotate("text", x = 0.845, y = 0.98, label = "Sub-\nSaharan\nAfrica", size = 4, family = "Arial", color = "grey77", lineheight = .75, hjust = 0) +
  annotate("text", x = 0.913, y = 0.92, label = paste0("0.89~Gt~of~CO[2]"), size = 3.1, family = "Arial", color = "grey76", hjust = 0, vjust = 0, parse = TRUE, lineheight = .75) +
#  annotate("text", x = 0.95, y = 0.99, label = paste0("of~CO[2]"), size = 3.1, family = "Arial", color = "grey76", hjust = 1.5, vjust = 2.45, parse = TRUE, angle = 90, lineheight = .75) +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_continuous(limits = c(0, 1))

ggsave(here("images", "annual-emissions-region-2019.svg"), device="svg", dpi=300)
```


```{r treemaps vulnerability, warning=FALSE, message=FALSE}
vulnerability_all %>%
  ggplot(aes(area = total_affected_cumulative, fill = region, subgroup = region)) +
  geom_treemap() +
  geom_treemap_subgroup_border(size = 0) +
  scale_fill_brewer(palette = "Greens") +
#  scale_fill_hue(l=40, c=35) +
#  geom_treemap_subgroup_text(grow = FALSE, place = "centre", size = 12, color = "black", reflow = TRUE) +
  theme_void() + 
  theme(legend.position = "none") +
  annotate("text", x = 0.17, y = 0.51, label = "East Asia & Pacific", size = 5, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.17, y = 0.47, label = paste0("3.34 bil (58.12%)"), size = 3.75, family = "Arial", color = "grey46", hjust = 0) +
  annotate("text", x = 0.95, y = 1, label = "Europe &\nCentral Asia", size = 3, family = "Arial", color = "grey26", hjust = 0, lineheight = .75, vjust = 0.1) +
  annotate("text", x = 0.945, y = 0.98, label = paste0("44.6 mil (0.78%)"), size = 2.25, family = "Arial", color = "grey46", hjust = 0) +
  annotate("text", x = 0.83, y = 0.95, label = "North\nAmerica", size = 4, family = "Arial", color = "grey20", hjust = 0, lineheight = .75) +
  annotate("text", x = 0.825, y = 0.9, label = paste0("114 mil (1.98%)"), size = 3, family = "Arial", color = "grey36", hjust = 0) +
  annotate("text", x = 0.95, y = 0.915, label = "Middle East\n& North\nAfrica", size = 3, family = "Arial", color = "grey20", lineheight = .75, hjust = 0) +
  annotate("text", x = 0.925, y = 0.85, label = paste0("51.2 mil (0.89%)"), size = 3, family = "Arial", color = "grey36", hjust = 0) +
  annotate("text", x = 0.76, y = 0.33, label = "South Asia", size = 5, family = "Arial", color = "grey20", hjust = 0) +
  annotate("text", x = 0.76, y = 0.29, label = paste0("1.66 bil (28.93%)"), size = 3.75, family = "Arial", color = "grey26", hjust = 0) +
  annotate("text", x = 0.83, y = 0.785, label = "Latin America &\nCaribbean", size = 4.5, family = "Arial", color = "grey20", hjust = 0, lineheight = .75) +
  annotate("text", x = 0.83, y = 0.735, label = paste0("166 mil (2.89%)"), size = 3.75, family = "Arial", color = "grey36", hjust = 0) +
  annotate("text", x = 0.6, y = 0.7935, label = "Sub-\nSaharan\nAfrica", size = 5, family = "Arial", color = "grey77", lineheight = .75, hjust = 0) +
  annotate("text", x = 0.6, y = 0.725, label = paste0("369 mil (6.41%)"), size = 3.15, family = "Arial", color = "grey76", hjust = 0, vjust = 1.45) +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_continuous(limits = c(0, 1))

ggsave(here("images", "cumulative-affected-region-1990-2018.svg"), device="svg", dpi=300)
```


## Session Info

Below is the session information, which include the version of R, loaded packages, and platforms used. This is helpful to know when conducting replications for data and analysis

```{r}
sessionInfo()
```

<!--## References-->


```{r export as an R script, eval=FALSE, message=FALSE, warning=FALSE}
knitr::purl("Vulnerability-Data-Analysis.Rmd", "Vulnerability-Data-Analysis.R")
knitr::write_bib(.packages(), "packages.bib")
```
